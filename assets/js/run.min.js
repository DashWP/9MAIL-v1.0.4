jQuery(document).ready((function(e){"use strict";let t=e(".emtmpl-email-preview-content");ViWec.Builder.init(),e(".emtmpl-show-sub-actions").on("click",(function(){e(".emtmpl-actions-back").slideToggle()})),e(".emtmpl-order-id-test").on("change",(function(){viWecChange=!0}));{let t,l=e("#title[name=post_title]"),a=e(".emtmpl-subject-quick-shortcode");l.on("focusout",(function(){t=this.selectionStart})),a.on("click",".dashicons-menu",(function(){a.find("ul").html(viWecShortcodeListValue.map((e=>`<li>${e}</li>`))),a.find("ul").toggle("fast")})),a.on("click","li",(function(){let n,o=l.val(),i=e(this).text();if(t){n=o.substr(0,t)+i+o.substr(t)}else n=o+i;l.val(n).focus(),e("#title-prompt-text").addClass("screen-reader-text"),a.find("ul").toggle("fast")}))}const l=e=>{var t="";if(e)try{t=decodeURIComponent(atob(e).split("").map((function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)})).join(""))}catch(t){return e}return t},a=e=>(["padding-left","padding-right","padding-top","padding-bottom"].includes(e)&&(e="padding"),["border-top-left-radius","border-top-right-radius","border-bottom-left-radius","border-bottom-right-radius"].includes(e)&&(e="border-radius"),e),n=e=>{if(e){let t=/rgba?[\s+]?\([\s+]?(\d+)[\s+]?,[\s+]?(\d+)[\s+]?,[\s+]?(\d+)[\s+]?\)/i,l=e.match(t);if(l){let a=viWecRgb2hex(l[0]);e=e.replace(t,a)}let a=/rgba?[\s+]?\([\s+]?(0)[\s+]?,[\s+]?(0)[\s+]?,[\s+]?(0)[\s+]?,[\s+]?(0)[\s+]?\)/i;return e.match(a)&&(e="transparent"),e=e.replace(/"/gi,"")}return""},o=(e,t)=>{let l=ViWec.Components._components[t],o=l?l.properties:"",i={};if(o){for(let t in o)if(o[t].htmlAttr){let l,m=a(o[t].key),s=e.get(0);s.style&&s.style.length>0&&s.style[m]?l=s.style[m]:s.currentStyle?l=s.currentStyle[m]:window.getComputedStyle&&(l=document.defaultView.getDefaultComputedStyle?document.defaultView.getDefaultComputedStyle(s,null).getPropertyValue(m):window.getComputedStyle(s,null).getPropertyValue(m)),l&&(i[m]=n(l))}i.width=e.css("width")}return i},i=()=>{let t={},l=e("#emtmpl-email-editor-wrapper"),i=e("#emtmpl-email-editor-content"),m=l.css("background-image");return m=m.replaceAll('"',"'"),t.style_container={"background-color":n(l.css("background-color")),"background-image":m,width:i.width(),responsive:i.attr("data-responsive")},t.rows={},e(viWecEditorArea).find(".emtmpl-block").each((function(l,i){let m=e(i).find(".emtmpl-layout-row"),s=e(i).find(".emtmpl-template-block");if(m.length){let i=e(m).attr("data-type"),s=e(m).attr("data-cols"),c=o(e(m),i);c.width="100%",t.rows[l]={props:{style_outer:c,type:i,dataCols:s},cols:{}};let r=e(m).find(".emtmpl-column-sortable");r.length&&r.each((function(i,m){let s=o(e(m),"layout/grid1cols");t.rows[l].cols[i]={props:{style:s},elements:{}};let c=e(m).find(".emtmpl-element");c.length&&c.each((function(o,m){let s=e(m).data("type");t.rows[l].cols[i].elements[o]=((t,l)=>{let o=ViWec.Components._components[l].properties,i={},m={},s={},c={};c.width=e(t).css("width");for(let l in o)if(o[l].htmlAttr){let d=o[l].target?e(t).find(o[l].target):e(t),p=a(o[l].key);switch(o[l].htmlAttr){case"innerHTML":i[p]=(r=d.html(),btoa(encodeURIComponent(r).replace(/%([0-9A-F]{2})/g,(function(e,t){return String.fromCharCode("0x"+t)}))));break;case"style":let e;e=ViWec.StyleManager.getStyle(d,o[l],p),e&&(c[p]=n(e));break;case"childStyle":s[o[l].target]||(s[o[l].target]={});let t=ViWec.StyleManager.getStyle(d,o[l],p);t&&(s[o[l].target][p]=n(t));break;default:let a=d.attr(o[l].htmlAttr),u=o[l].default?o[l].default:"";a=a||u,m[p]=a}}var r;return{type:l,style:c,content:i,attrs:m,childStyle:s}})(m,s)}))}))}s.length&&(t.rows[l]=s.attr("data-block"))})),JSON.stringify(t)};if(e("#save-post").on("click",(function(){e("input[name=post_status]").val("draft")})),e("form").on("submit",(function(t){e(window).unbind("beforeunload");let l=i();return e("<input/>").attr({type:"hidden",name:"emtmpl_email_structure",value:l}).appendTo("form#post"),!0})),e(".emtmpl-preview-email-btn").on("click",(function l(){let a={action:"emtmpl_preview_template",nonce:viWecParams.nonce,data:i(),order_id:e(".emtmpl-order-id-test").val(),custom_css:e("#emtmpl-custom-css textarea").val(),direction:e(".emtmpl-settings-direction").val()},n=e(this),o=e(".vi-ui.modal");!1===viWecChange?(o.modal("show"),n.hasClass("mobile")&&t.addClass("emtmpl-mobile-preview"),n.hasClass("desktop")&&t.removeClass("emtmpl-mobile-preview")):e.ajax({url:viWecParams.ajaxUrl,type:"post",dataType:"html",data:a,beforeSend:function(){n.addClass("loading").unbind()},success:function(t){t&&(o.find(".emtmpl-email-preview-content").html(t),o.modal("show"),e(".emtmpl-email-preview-content a").on("click",(function(e){e.preventDefault(),e.stopImmediatePropagation()})))},error:function(e){console.log(e)},complete:function(){n.removeClass("loading"),n.bind("click",l),viWecChange=!1,n.hasClass("mobile")&&t.addClass("emtmpl-mobile-preview"),n.hasClass("desktop")&&t.removeClass("emtmpl-mobile-preview")}})})),e(".emtmpl-send-test-email-btn").on("click",(function t(){let l=e(".emtmpl-send-test-email-btn"),a=e(".emtmpl-to-email").val(),n=[];if(!a)return alert("Please input your email"),void e(".vi-ui.modal").modal("hide");e(".emtmpl-attachment-el input").each((function(){e(this).val()&&n.push(e(this).val())}));let o={action:"emtmpl_send_test_email",nonce:viWecParams.nonce,data:i(),order_id:e(".emtmpl-order-id-test").val(),custom_css:e("#emtmpl-custom-css textarea").val(),email:a,attachments:n,direction:e(".emtmpl-settings-direction").val()};e.ajax({url:viWecParams.ajaxUrl,type:"post",dataType:"json",data:o,beforeSend:function(){l.addClass("loading").unbind()},success:function(e){let t=e.success?"#00DA00":"red";viWecNoticeBox(e.data,t)},complete:function(){l.removeClass("loading").bind("click",t),e(".vi-ui.modal").modal("hide")}})})),e(".emtmpl-mobile-view").on("click",(function(){t.addClass("emtmpl-mobile-preview")})),e(".emtmpl-pc-view").on("click",(function(){t.removeClass("emtmpl-mobile-preview")})),ViWec.renderRows=(t,a=!0)=>{let n=[];for(let o in t)if("string"==typeof t[o]||"number"==typeof t[o]){let l=+t[o],a=viWecParams.templateBlocks.find((e=>+e.id==+l));if(a){let t=a.data,o=e(`<div class="emtmpl-block"><div class="emtmpl-template-block" data-type="blocks" data-block="${l}"></div></div>`),i=ViWec.renderRows(t.rows,!1);o.find(".emtmpl-template-block").append(i),o.handleRow(),n.push(o)}}else{if(e.isEmptyObject(t[o].cols))continue;let i=e(viWecTmpl("emtmpl-block",{type:t[o].props.type,colsQty:t[o].props.dataCols}));a||i.find(".emtmpl-column-control").remove(),i.find(".emtmpl-layout-row").css(t[o].props.style_outer),i.find(".emtmpl-column").each((function(n){let m=e(this);e.isEmptyObject(t[o].cols[n].elements)||m.removeClass("emtmpl-column-placeholder");let s=t[o].cols[n].props.style;delete s.width,m.find(".emtmpl-column-sortable").css(s);for(let i in t[o].cols[n].elements){let s=t[o].cols[n].elements[i],c=s.type,r=s.style,d=s.content,p=0!==s.attrs.length?s.attrs:{},u=s.childStyle,h=ViWec.Components._components[c];if(delete r.width,void 0===h)continue;let f=h.properties,v=e(`<div class='emtmpl-element' data-type="${c}"></div>`).append(h.html);for(let e in f)if(f[e].htmlAttr&&!1!==f[e].visible){let t=f[e].target?v.find(f[e].target):v;switch(f[e].htmlAttr){case"innerHTML":let a=l(d[f[e].key]);if(f[e].renderShortcode){let e=t.clone();e=e.removeClass().html(ViWec.viWecReplaceShortcode(a)).addClass("emtmpl-text-view"),t.html(a).hide(),t.after(e)}else t.html(a);"function"==typeof f[e].onChange&&f[e].onChange(t,a);break;case"style":r&&t.css(r);break;case"childStyle":u[f[e].target]&&t.css(u[f[e].target]);break;default:if(t.attr(f[e].htmlAttr,p[f[e].key]),"function"==typeof f[e].onChange){let l=ViWec.viWecReplaceShortcode(p[f[e].key]);f[e].onChange(t,p[f[e].key],l)}}}a&&v.handleElement(),m.find(".emtmpl-column-sortable").append(v)}a&&(m.handleColumn(),m.find(".emtmpl-column-sortable").columnSortAble()),i.find(".emtmpl-flex").append(m)})),a?i.handleRow():(i.removeClass("emtmpl-block"),i.find(".emtmpl-element").removeClass("emtmpl-element"),i.find(".emtmpl-column-sortable").removeClass("emtmpl-column-sortable"),i.find(".emtmpl-layout-row").removeClass("emtmpl-layout-row")),n.push(i)}return n},ViWec.viWecDrawTemplate=t=>{if(!t)return;e(viWecEditorArea).empty();let l={backgroundColor:t.style_container["background-color"]||"",backgroundImage:t.style_container["background-image"]||""};e("#emtmpl-email-editor-wrapper").css(l),e("#emtmpl-email-editor-content").css({width:t.style_container.width}).attr("data-responsive",t.style_container.responsive||380),e(viWecEditorArea).append(ViWec.renderRows(t.rows))},"undefined"!=typeof viWecLoadTemplate){let e=JSON.parse(viWecLoadTemplate);ViWec.viWecDrawTemplate(e)}e(".emtmpl-export-data").on("click",(function(){let t=i(),l=new RegExp(viWecParams.siteUrl,"g");t=t.replace(l,"{_site_url}"),e("#emtmpl-exim-data").val(t)})),e(".emtmpl-import-data").on("click",(function(){let t=e("#emtmpl-exim-data").val();t=t.replace(/{_site_url}/g,viWecParams.siteUrl),t&&ViWec.viWecDrawTemplate(JSON.parse(t))})),e(".emtmpl-copy-data").on("click",(function(){e("#emtmpl-exim-data").select(),document.execCommand("copy")})),e("#emtmpl-element-search input.emtmpl-search").on("keyup",(function(){let t=e(this).val().toUpperCase(),l=e("#emtmpl-components-list li");for(let a=0;a<l.length;a++){e(l[a]).find(".emtmpl-ctrl-title").text().toUpperCase().indexOf(t)>-1?e(l[a]).show():e(l[a]).hide()}}));const m={init(){let t=e(".emtmpl-set-email-type");this.setupPage(),this.setupPreviewModal(),this.emailTypeChange(),this.hideRules(t.val()),this.hideElements(t.val()),this.addNewTemplate(),this.attachmentFile(),this.direction()},setupPage(){e(window).bind("beforeunload"),e(document).width()<=1400&&e("body").addClass("folded"),e(".hndle").removeClass("hndle"),e("form").bind("keypress",(function(e){13===e.keyCode&&(e.preventDefault(),e.stopImmediatePropagation())})),e(document).on("click",(function(t){e(t.target).is(".emtmpl-quick-shortcode-list")||e(t.target).is(".dashicons.dashicons-menu")||(e(".emtmpl-quick-shortcode-list").hide(),e(".emtmpl-subject-quick-shortcode ul").hide())})),e(".emtmpl-select2").select2({placeholder:e(this).attr("data-placeholder")}),e("#emtmpl-control-panel .menu .item").tab(),e(".emtmpl-toggle-admin-bar").on("click",(function(){e(this).toggleClass("dashicons-arrow-left dashicons-arrow-right",1e3),e("body.wp-admin").toggleClass("emtmpl-admin-bar-hidden",1e3),e.ajax({url:ajaxurl,type:"post",dataType:"json",data:{action:"emtmpl_change_admin_bar_stt"}})})),e(".emtmpl-quick-add-layout-btn").on("click",(function(){e(".emtmpl-layout-list").toggle()}))},setupPreviewModal(){e("body").on("click",".emtmpl-email-preview a, #emtmpl-email-editor-wrapper a",(function(e){e.preventDefault(),e.stopImmediatePropagation()}))},addNewTemplate(){if(void 0!==viWecParams.addNew){let t=viWecParams.addNew.type||"",l=viWecParams.addNew.style||"";t&&l&&viWecFunctions.doChangeSampleTemplate(t,l),e(".emtmpl-samples-type").val(t).trigger("change"),e(".emtmpl-samples-style").val(l).trigger("change"),delete viWecParams.addNew}},emailTypeChange(){e(".emtmpl-set-email-type").on("change",(function(){let t=e(this).val();m.hideRules(t),m.hideElements(t),(e=>{let t=Object.keys(viWecParams.commonShortcode)||[];if(viWecParams.shortcode[e]){let l=Object.keys(viWecParams.shortcode[e]);viWecShortcodeListValue=[...new Set([...t,...l])]}else viWecShortcodeListValue=[...new Set([...t])]})(t),"default"===t?e('.emtmpl-element[data-type="html/recover_content"] .emtmpl-element-handle-inner').hide():(e('.emtmpl-element[data-type="html/recover_content"]').remove(),e(".emtmpl-layout-handle-outer").show())})).trigger("change")},hideRules(e){},hideElements(t){let l=(viWecParams.accept_elements||"")[t]||"";if(l){e("#emtmpl-components-list .emtmpl-control-btn").parent().addClass("emtmpl-hidden");for(let t of l)e(`#emtmpl-components-list .emtmpl-control-btn[data-type='${t}']`).parent().removeClass("emtmpl-hidden")}else e("#emtmpl-components-list .emtmpl-control-btn").parent().removeClass("emtmpl-hidden");"default"===t?e("#emtmpl-components-list .emtmpl-control-btn[data-type='html/recover_content']").parent().removeClass("emtmpl-hidden"):e("#emtmpl-components-list .emtmpl-control-btn[data-type='html/recover_content']").parent().addClass("emtmpl-hidden")},attachmentFile(){e(".emtmpl-attachment-el").on("click",".emtmpl-remove-attachment",(function(t){e(this).parent().remove()}));let t=wp.media({multiple:!0});e(".emtmpl-add-attachment-file").on("click",(function(){let l=e(".emtmpl-attachments-list");t.on("select",(function(a){t.state().get("selection").each((function(t){t=t.toJSON();let{id:a,filename:n}=t;if(0===l.find(`[value=${a}]`).length){let t=e(`<div class="emtmpl-attachment-el vi-ui button tiny">\n                                        <a href="${viWecParams.uploadUrl}?item=${a}" target="_blank">${n}</a>\n                                        <input type="hidden" name="emtmpl_attachments[]" value="${a}">\n                                        <i class="emtmpl-remove-attachment dashicons dashicons-no-alt"></i>\n                                    </div>`);t.on("click",".emtmpl-remove-attachment",(function(){t.remove()})),l.append(t)}}))})).open()}))},direction(){e(".emtmpl-settings-direction").on("change",(function(){let t=e(this).val(),l=e("#emtmpl-email-editor-content");l.removeClass("emtmpl-direction-rtl emtmpl-direction-ltr"),l.addClass("emtmpl-direction-"+t)}))}};m.init()}));